var NUGGET;(()=>{"use strict";var e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{asset:()=>n,directory:()=>s,mime:()=>l,project:()=>o,renderAnimation:()=>d});const i={nowDirectory:"",loadPrevDirectory:function(){let e=i.nowDirectory.split("/"),t=e.slice(-e.length,-1);ipc.requestAllDir(t.join("/"))},add:function(e){fetch(`file://${e}`).then((e=>e.blob())).then((t=>{let i=URL.createObjectURL(t),n=t.type.split("/")[0],s=document.querySelector("element-control");"image"==n?s.addImage(i,e):"video"==n?s.addVideo(i,e):"audio"==n&&s.addAudio(i,e)}))}},n=i,s={select:function(){const e=document.querySelector("#projectFolder");window.electronAPI.req.dialog.openDirectory().then((t=>{e.value=t||"/",window.electronAPI.req.filesystem.getAllDirectory(String(e.value))}))}},l={mimeArray:{png:{type:"image"},jpg:{type:"image"},jpeg:{type:"image"},gif:{type:"image"},mp4:{type:"video"},mov:{type:"video"},avi:{type:"video"},wmv:{type:"video"},mpg:{type:"video"},mkv:{type:"video"},webm:{type:"video"},mp3:{type:"audio"},wav:{type:"audio"}},lookup:function(e){const t=e.split(".");return t.length<=1?{type:"unknown"}:this.mimeArray[t[t.length-1]]?{type:this.mimeArray[t[t.length-1]].type}:{type:"unknown"}}},o={save:function(){const e=new JSZip,t=document.querySelector("element-timeline"),i=document.querySelector("element-timeline").timeline,n=Number(document.querySelector("#projectDuration").value),s=(document.querySelector("#projectFolder").value,elementControlComponent.previewRatio);window.electronAPI.req.project.save().then((l=>{let o=l||"nonefile";if("nonefile"==o)return 0;console.log(o);const r={videoDuration:n,previewRatio:s,videoDestination:o};e.file("timeline.json",JSON.stringify(i)),e.file("renderOptions.json",JSON.stringify(r)),e.generateAsync({type:"blob"}).then((async function(e){const i=(e=>{for(var t="",i=new Uint8Array(e),n=i.byteLength,s=0;s<n;s++)t+=String.fromCharCode(i[s]);return window.btoa(t)})(await e.arrayBuffer());window.electronAPI.req.filesystem.writeFile(o,i,"base64").then((e=>{console.log("saved!"),t.appendCheckpointInHashTable()}))}))}))},load:function(){new JSZip;const e=document.querySelector("element-timeline"),t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("accept",".ngt"),t.click(),t.addEventListener("change",(function(){e.resetTimelineData();let t=this.files[0].path;window.electronAPI.req.filesystem.readFile(t).then((t=>{JSZip.loadAsync(t).then((function(t){t.file("timeline.json").async("string").then((async t=>{let i=JSON.parse(t);console.log(i["0f5195f2-4ffb-4a41-9a6a-069db9eefd11"]),await e.patchTimeline(i)}))}))}))}),!1)}},r=function(e){rendererUtil.showProgressModal(),document.querySelector("#progress").style.width=`${e}%`,document.querySelector("#progress").innerHTML=`${Math.round(e)}%`},a={state:{animateElements:{},elements:void 0,options:void 0,numberOfRenderingRequired:0,renderingCount:0,renderingProgress:0},initAnimateElementState:function(e){let t=document.createElement("canvas");t.classList.add("d-none"),t.setAttribute("width","1920"),t.setAttribute("height","1080");let i=t.getContext("2d");a.state.animateElements[e]={renderFrameLength:0,savedFrameCount:0,isCombineFrames:!1,canvas:t,context:i}},render:function(e,t){console.log(e),a.state.elements=e,a.state.options=t,a.state.numberOfRenderingRequired=0,r(0);let i=`${t.videoDestinationFolder}/temp`;window.electronAPI.req.filesystem.mkdir(i,{recursive:!0}).then((t=>{window.electronAPI.req.filesystem.emptyDirSync(i);for(const t in e)if(Object.hasOwnProperty.call(e,t)){const n=e[t];if(0==n.hasOwnProperty("animation"))continue;if("image"!==n.filetype)continue;if(1==n.animation.position.isActivate){a.initAnimateElementState(t),a.state.numberOfRenderingRequired+=1;let e=a.renderFrame({elementId:t,elements:n});for(let n=0;n<e.length;n++)a.saveFrame({elementId:t,data:e[n],outputDir:i,frame:n})}}0==a.state.numberOfRenderingRequired&&a.renderOutput()}))},renderFrame:function({elementId:e,elements:t}){let i=a.state.animateElements[e].canvas,n=a.state.animateElements[e].context,s=t.animation.position.allpoints,l=[];a.state.animateElements[e].renderFrameLength=s[0].length;for(let t=0;t<s[0].length;t++){n.clearRect(0,0,i.width,i.height);let o={x:s[0][t].y,y:t<s[1].length?s[1][t].y:s[1][s[1].length-1].y};a.drawImage(e,n,o),n.stroke(),l.push(i.toDataURL("image/png"))}return l},drawImage:function(e,t,i){let n=document.querySelector(`element-control-asset[element-id='${e}']`).querySelector("img"),s=0+i.x,l=i.y,o=a.state.elements[e].width,r=a.state.elements[e].height;t.drawImage(n,s,l,o,r)},saveFrame:function({data:e,outputDir:t,frame:i,elementId:n}){const s=e.substring("data:image/png;base64,".length),l=`${t}/frame-${n}-${String(i+1).padStart(4,"0")}.png`;window.electronAPI.req.filesystem.writeFile(l,s,"base64").then((e=>{a.state.animateElements[n].savedFrameCount+=1,a.state.animateElements[n].savedFrameCount>=a.state.animateElements[n].renderFrameLength&&0==a.state.animateElements[n].isCombineFrames&&(a.state.animateElements[n].isCombineFrames,a.combineFrame({elementId:n,outputDir:t})),console.log("File written successfully\n")}))},combineFrame:function({elementId:e,outputDir:t}){let i=`${t}/${e}.webm`;window.electronAPI.req.ffmpeg.combineFrame(t,e),window.electronAPI.res.render.finishCombineFrame(((t,n)=>{if(n!=e)return 0;a.state.elements[e].filetype="video",a.state.elements[e].isExistAudio=!1,a.state.elements[e].localpath=i,a.state.elements[e].trim={startTime:0,endTime:a.state.elements[e].duration},a.state.elements[e].height=1080,a.state.elements[e].width=1920,a.state.elements[e].location={x:0,y:50},a.state.elements[e].codec={video:"libvpx-vp9",audio:"default"},a.state.renderingCount+=1,a.state.renderingProgress=a.state.renderingCount/a.state.numberOfRenderingRequired*100,r(a.state.renderingProgress),a.state.renderingCount>=a.state.numberOfRenderingRequired&&a.renderOutput()}))},renderOutput:function(){console.log("REND processing"),window.electronAPI.req.render.outputVideo(a.state.elements,a.state.options)}},d=a;class m extends HTMLElement{constructor(){super(),this.blobThumbnail={},this.nowDirectory=""}render(){const e=this.template();this.innerHTML=e}template(){return'<div class="row px-2"></div>'}getFile(e){let t=e.split("."),i=t.length;i<=2||t[i-1],this.querySelector("div").insertAdjacentHTML("beforeend",`<asset-file asset-name="${e}"></asset-file>`)}getFolder(e){let t=e.split(".").length;t<=2||splitedFilename[t-1],this.querySelector("div").insertAdjacentHTML("beforeend",`<asset-folder asset-name="${e}"></asset-folder>`)}clearList(){this.querySelector("div").innerHTML=""}connectedCallback(){this.render()}}class h extends HTMLElement{constructor(){super(),this.classList.add("col-4","d-flex","flex-column","bd-highlight","overflow-hidden","mt-1","asset"),this.filename=this.getAttribute("asset-name"),this.directory=document.querySelector("asset-list").nowDirectory}async render(){const e=NUGGET.mime.lookup(this.filename).type,t=`file://${this.directory}/${this.filename}`,i=document.querySelector("asset-list");let n;if("image"==e)n=this.templateImage(t);else if("video"==e)if(console.log(t),i.blobThumbnail.hasOwnProperty(t)){let e=i.blobThumbnail[t];n=this.templateVideoThumbnail(e)}else{let e=await this.captureVideoThumbnail(t);i.blobThumbnail[t]=e,n=this.templateVideoThumbnail(e)}else n=this.template(e);this.innerHTML=n}template(e="unknown"){return`<span class="material-symbols-outlined icon-lg align-self-center"> ${{video:"video_file",audio:"audio_file",unknown:"draft"}[e]} </span>\n        <b class="align-self-center text-ellipsis-scroll text-light text-center">${this.filename}</b>`}templateImage(e){return`<img src="${e}" alt="" class="align-self-center asset-preview">\n        <b class="align-self-center text-ellipsis-scroll text-light text-center">${this.filename}</b>`}templateVideoThumbnail(e){return`\n        <div class="position-relative align-self-center">\n        <img src="${e}" alt="" class="align-self-center asset-preview w-100">\n        <span class="material-symbols-outlined position-absolute icon-center ">\n        play_arrow\n        </span>\n        </div>\n        \n        <b class="align-self-center text-ellipsis-scroll text-light text-center">${this.filename}</b>`}handleClick(){NUGGET.asset.add(`${this.directory}/${this.filename}`)}async captureVideoThumbnail(e){const t=await new Promise(((t,i)=>{fetch(`${e}`).then((e=>e.blob())).then((e=>{const i=URL.createObjectURL(e),n=document.createElement("video");n.src=i,n.preload="metadata",n.onloadedmetadata=async()=>{const e=document.createElement("canvas");n.addEventListener("seeked",(()=>{let i=n.videoWidth,s=n.videoHeight;e.width=i,e.height=s,e.getContext("2d").drawImage(n,0,0,e.width,e.height),e.toBlob((e=>{const i=document.createElement("img"),n=URL.createObjectURL(e);i.onload=()=>{URL.revokeObjectURL(n)},t(n)}))})),n.currentTime=1}}))}));return console.log(t,"a"),t}async connectedCallback(){await this.render(),this.addEventListener("click",this.handleClick.bind(this))}disconnectedCallback(){this.removeEventListener("click",this.handleClick)}}class c extends HTMLElement{constructor(){super(),this.classList.add("col-4","d-flex","flex-column","bd-highlight","overflow-hidden","mt-1","asset"),this.foldername=this.getAttribute("asset-name"),this.directory=document.querySelector("asset-list").nowDirectory}render(){const e=this.template();this.innerHTML=e}template(){return`<span class="material-symbols-outlined icon-lg align-self-center"> folder </span>\n        <b class="align-self-center text-ellipsis text-light text-center">${this.foldername}</b>`}handleClick(){ipc.requestAllDir(`${this.directory}/${this.foldername}`)}connectedCallback(){this.render(),this.addEventListener("click",this.handleClick.bind(this))}disconnectedCallback(){this.removeEventListener("click",this.handleClick)}}class u extends HTMLElement{constructor(){super(),this.directory=""}render(){const e=this.template();this.innerHTML=e}template(){return'<div class="row p-0 mt-2">\n        <div class="col-2">\n            <button class="btn btn-transparent btn-sm"><span class="material-symbols-outlined icon-sm"> arrow_upward </span> </button>\n        </div>\n        <div class="col-10">\n            <input type="text" class="form-control" aria-describedby="basic-addon1" value="" disabled>\n        </div>\n        </div>'}updateDirectoryInput(e){this.querySelector("div").querySelectorAll("div")[1].querySelector("input").value=e}clickPrevDirectoryButton(){this.directory=document.querySelector("asset-list").nowDirectory;let e=this.directory.split("/"),t=e.slice(-e.length,-1);ipc.requestAllDir(t.join("/"))}connectedCallback(){this.render(),this.querySelector("div").querySelectorAll("div")[0].querySelector("button").addEventListener("click",this.clickPrevDirectoryButton.bind(this))}disconnectedCallback(){this.querySelector("div").querySelectorAll("div")[0].querySelector("button").removeEventListener("click",this.clickPrevDirectoryButton)}}class p extends HTMLElement{constructor(){super()}render(){const e=this.template();this.classList.add("bg-dark","position-absolute","d-none"),this.style.left="0px",this.style.top="0px",this.style.width="100%",this.style.height="100%",this.style.zIndex="10000",this.style.opacity="80%",this.style.paddingTop="46vh",this.innerHTML=e}template(){return'\n        <div class="row justify-content-center align-items-start">\n            <b class="col-12 align-self-center text-light position-fixed text-center">\n                여기에 파일을 드롭해주세요\n            </b>\n        </div>'}handleDragEnter(){console.log("dragenter"),this.classList.remove("d-none")}handleDragOver(e){e.preventDefault(),console.log("dragover"),this.classList.remove("d-none")}handleDragLeave(){this.classList.add("d-none")}handleDrop(e){e.preventDefault(),console.log("drop");let t=e.dataTransfer.files[0].path;console.log(t),NUGGET.asset.add(t),this.classList.add("d-none")}connectedCallback(){this.render(),document.addEventListener("dragenter",this.handleDragEnter.bind(this)),document.addEventListener("dragover",this.handleDragOver.bind(this)),this.addEventListener("dragleave",this.handleDragLeave.bind(this)),this.addEventListener("drop",this.handleDrop.bind(this))}disconnectedCallback(){}}const y={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let g;const v=new Uint8Array(16);function f(){if(!g&&(g="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!g))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return g(v)}const b=[];for(let e=0;e<256;++e)b.push((e+256).toString(16).slice(1));const w=function(e,t,i){if(y.randomUUID&&!t&&!e)return y.randomUUID();const n=(e=e||{}).random||(e.rng||f)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){i=i||0;for(let e=0;e<16;++e)t[i+e]=n[e];return t}return function(e,t=0){return(b[e[t+0]]+b[e[t+1]]+b[e[t+2]]+b[e[t+3]]+"-"+b[e[t+4]]+b[e[t+5]]+"-"+b[e[t+6]]+b[e[t+7]]+"-"+b[e[t+8]]+b[e[t+9]]+"-"+b[e[t+10]]+b[e[t+11]]+b[e[t+12]]+b[e[t+13]]+b[e[t+14]]+b[e[t+15]]).toLowerCase()}(n)};class T extends HTMLElement{constructor(){super(),this.elementControl,window.addEventListener("DOMContentLoaded",(()=>{this.elementControl=document.querySelector("element-control")})),this.timeline={},this.timelineHashTable={},this.appendCheckpointInHashTable(),this.copyedTimelineData={}}generateHash(e){let t,i,n=0;if(0===e.length)return n;for(t=0;t<e.length;t++)i=e.charCodeAt(t),n=(n<<5)-n+i,n|=0;return n}getTime(){return Date.now()}appendCheckpointInHashTable(){let e=JSON.stringify(this.timeline),t=this.generateHash(e),i=this.getTime();this.timelineHashTable[i]=t}isTimelineChange(){let e=JSON.stringify(this.timeline),t=this.generateHash(e),i=Object.keys(this.timelineHashTable).length,n=Object.keys(this.timelineHashTable)[i-1];return t!=this.timelineHashTable[n]}render(){const e=this.template();this.classList.add("col-12","cursor-default","h-100","line"),this.innerHTML=e}template(){return"\n        <element-timeline-ruler></element-timeline-ruler>\n        <element-timeline-cursor></element-timeline-cursor>\n\n        "}replaceTimelineBarHeight(e){this.querySelector(".timeline-bar").style.height=`${e}px`}getTimelineScrollHeight(){return this.scrollHeight}async patchTimeline(e){this.timeline=e,this.elementControl.timeline=e;for(const t in e)if(Object.hasOwnProperty.call(e,t)){const i=e[t];this.patchElementInTimeline({elementId:t,element:i})}}async patchElementInTimeline({elementId:e,element:t}){if("image"==t.filetype){let i=await this.getBlobUrl(`file://${t.localpath}`);this.timeline[e].blob=String(i),this.elementControl.showImage(e)}else if("video"==t.filetype){let i=await this.getBlobUrl(`file://${t.localpath}`);this.timeline[e].blob=String(i),this.elementControl.showVideo(e)}else if("text"==t.filetype)this.elementControl.showText(e);else if("audio"==t.filetype){let i=await this.getBlobUrl(`file://${t.localpath}`);this.timeline[e].blob=String(i),this.elementControl.showAudio(e)}this.addElementBar(e)}resetTimelineData(){this.timeline={},this.removeAllTimelineBars(),this.elementControl.removeAllElementAsset()}removeAllTimelineBars(){this.querySelectorAll("element-bar").forEach((e=>{e.remove()}))}async getBlobUrl(e){const t=await fetch(e),i=await t.blob();return URL.createObjectURL(i)}addElementBar(e){const t=this.templateElementBar(e);this.insertAdjacentHTML("beforeend",t),this.getTimelineScrollHeight()}templateElementBar(e){this.timeline[e].duration;let t=this.timeline[e].filetype,i=this.timeline[e].localpath.split("/"),n=(i[i.length-1],this.getElementType(t));return"static"==n?`\n            <element-bar element-id="${e}" element-type="static"></element-bar> \n\n            <animation-panel element-id="${e}"> \n                <animation-panel-item animation-type="position" element-id="${e}"></animation-panel-item> \n\n            </animation-panel> \n            `:"dynamic"==n?`<element-bar element-id="${e}" element-type="dynamic"></element-bar>`:"none"}getElementType(e){let t="undefined";const i={static:["image","text","png","jpg","jpeg"],dynamic:["video","audio","mp4","mp3","mov"]};for(const n in i)if(Object.hasOwnProperty.call(i,n)&&i[n].indexOf(e)>=0){t=n;break}return t}togglePlayer(){1==this.elementControl.isPaused?this.elementControl.play():this.elementControl.stop()}removeAnimationPanelById(e){let t=this.querySelector(`animation-panel[element-id="${e}"]`);if(!t)return 0;t.remove()}removeElementInTimelineData(e){delete this.timeline[e]}removeElementById(e){this.querySelector(`element-bar[element-id="${e}"]`).remove()}removeSeletedElements(){this.elementControl.selectElementsId.forEach((e=>{this.removeElementById(e),this.removeElementInTimelineData(e),this.removeAnimationPanelById(e),this.elementControl.removeElementById(e)})),this.elementControl.selectElementsId=[]}copySeletedElement(){let e={};this.elementControl.selectElementsId.forEach((t=>{let i=w();e[i]=this.timeline[t]})),this.copyedTimelineData=e}pasteElement({elementId:e,element:t}){this.timeline[e]=_.cloneDeep(t)}showAnimationPanel(e){this.querySelector(`animation-panel[element-id='${e}']`).show()}hideAnimationPanel(e){this.querySelector(`animation-panel[element-id='${e}']`).hide()}showKeyframeEditor(e,t){let i=new bootstrap.Offcanvas(document.getElementById("option_bottom")),n=document.querySelector("#timelineOptionBody"),s=document.querySelector("#timelineOptionTargetElement");n.innerHTML=`<keyframe-editor element-id="${e}" animation-type="${t}"></keyframe-editor>`,n.classList.remove("d-none"),s.value=e,i.show()}deactivateSeletedBar(){this.elementControl.selectElementsId.forEach((e=>{document.querySelector(`element-bar[element-id='${e}']`).unselectThisElement()}))}fixRulerOnTop(){const e=this.scrollTop,t=document.querySelector("element-timeline-ruler"),i=document.querySelector("element-timeline-cursor");t.setTopPosition(e),i.style.top=`${e}px`}scrollKeyframeEditor(){if(0==!!document.querySelector("keyframe-editor"))return 0;document.querySelector("keyframe-editor").scrollTo(this.scrollLeft,this.scrollTop)}handleKeydown(e){if(console.log(e.keyCode),1==this.elementControl.existActiveElement)return 0;if(32==e.keyCode&&(e.preventDefault(),this.togglePlayer()),8==e.keyCode&&(e.preventDefault(),this.removeSeletedElements()),e.ctrlKey&&86==e.keyCode){console.log("CV",this,this.copyedTimelineData);for(const e in this.copyedTimelineData)Object.hasOwnProperty.call(this.copyedTimelineData,e)&&(this.pasteElement({elementId:e,element:this.copyedTimelineData[e]}),this.patchElementInTimeline({elementId:e,element:this.copyedTimelineData[e]}))}e.ctrlKey&&67==e.keyCode&&(console.log("CC"),this.copySeletedElement()),e.ctrlKey&&88==e.keyCode&&(this.copySeletedElement(),this.removeSeletedElements())}handleMousedown(){this.elementControl.deactivateAllOutline(),this.deactivateSeletedBar()}handleScroll(){this.fixRulerOnTop(),this.scrollKeyframeEditor()}connectedCallback(){this.render(),this.addEventListener("mousedown",this.handleMousedown.bind(this)),this.addEventListener("scroll",this.handleScroll.bind(this)),document.addEventListener("keydown",this.handleKeydown.bind(this))}}class x extends HTMLElement{constructor(){super(),this.elementTimelineRuler,window.addEventListener("DOMContentLoaded",(()=>{this.elementTimelineRuler=document.querySelector("element-timeline-ruler")}))}render(){this.classList.add("timeline-bar"),this.setAttribute("id","timeline_bar"),this.style.left="0px",this.style.top="0px"}move(e){this.style.left=`${e}px`}handleMousedown(e){this.elementTimelineRuler.moveTime(e),this.elementTimelineRuler.mousemoveEventHandler=this.elementTimelineRuler.handleMousemove.bind(this.elementTimelineRuler),document.addEventListener("mousemove",this.elementTimelineRuler.mousemoveEventHandler)}handleMouseup(e){document.removeEventListener("mousemove",this.elementTimelineRuler.mousemoveEventHandler)}connectedCallback(){this.render(),this.addEventListener("mousedown",this.handleMousedown.bind(this)),document.addEventListener("mouseup",this.handleMouseup.bind(this))}}class E extends HTMLElement{constructor(){super(),this.mousemoveEventHandler=void 0,this.mouseTimeout=void 0}render(){const e=this.template();this.classList.add("timeline-ruler","ruler"),this.innerHTML=e,this.addTickNumber(10)}template(){return'<ul class="ruler-x">\n        <li></li><li></li><li></li><li></li><li></li> \x3c!-- repeat --\x3e\n      </ul>'}addTickNumber(e){let t="<li></li>".repeat(e);this.querySelector("ul").innerHTML=t}updateRulerSpace(e){const t=50*e,i=5*e;this.style.setProperty("--ruler2-space",t),this.style.setProperty("--ruler1-space",i)}updateRulerLength(e){let t=200*Number(e.value);this.changeWidth(t),this.addTickNumber(Number(e.value))}changeWidth(e){this.style.width=`${e}px`}setTopPosition(e){this.style.top=`${e}px`}moveTime(e){const t=document.querySelector("element-timeline-cursor"),i=document.querySelector("element-timeline"),n=document.querySelector("element-control");n.progress=e.pageX+i.scrollLeft,n.progressTime=n.getTimeFromProgress(),n.stop(),n.showTime(),n.appearAllElementInTime(),t.move(e.pageX+i.scrollLeft)}handleMousemove(e){const t=document.querySelector("element-timeline-cursor"),i=document.querySelector("element-timeline"),n=document.querySelector("element-control");t.move(e.pageX+i.scrollLeft),n.showTime(),clearTimeout(this.mouseTimeout),this.mouseTimeout=setTimeout((()=>{clearInterval(this.resizeInterval),this.moveTime(e)}),100)}handleMousedown(e){e.stopPropagation(),this.moveTime(e),this.mousemoveEventHandler=this.handleMousemove.bind(this),document.addEventListener("mousemove",this.mousemoveEventHandler)}handleMouseup(e){document.removeEventListener("mousemove",this.mousemoveEventHandler)}connectedCallback(){this.render(),this.addEventListener("mousedown",this.handleMousedown.bind(this)),document.addEventListener("mouseup",this.handleMouseup.bind(this))}}class S extends HTMLElement{constructor(){super(),this.timeline=document.querySelector("element-timeline").timeline,this.elementControl=document.querySelector("element-control"),this.elementId=this.getAttribute("element-id"),this.elementBarType=this.getAttribute("element-type")||"static",this.width=this.millisecondsToPx(this.timeline[this.elementId].duration),this.startTime=this.millisecondsToPx(this.timeline[this.elementId].startTime),this.isDrag=!1,this.isResize=!1,this.resizeLocation="left",this.initialDuration=1e3,this.initialPosition={x:0,y:0};let e=this.timeline[this.elementId].localpath.split("/");this.filepath=e[e.length-1],this.resizeEventHandler,this.dragEventHandler}render(){let e;e="static"==this.elementBarType?this.templateStatic():this.templateDynamic();const t=this.getRandomColor();this.classList.add("element-bar","d-block"),this.setAttribute("style",`width: ${this.width}px; left: ${this.startTime}px; background-color: ${t};`),this.setAttribute("value",this.elementId),this.innerHTML=e,this.setTrimBar()}setTrimBar(){if("dynamic"==this.elementBarType){let e=this.millisecondsToPx(this.timeline[this.elementId].trim.startTime),t=this.millisecondsToPx(this.timeline[this.elementId].trim.endTime);this.setTrimStart(e),this.setTrimEnd(t),this.elementControl.changeTimelineRange()}}templateStatic(){return`\n        ${this.filepath}\n        <div class="element-bar-resize-left position-absolute" onmousedown="this.parentNode.resizeMousedown(this, 'left')"></div>\n        <div class="element-bar-resize-right position-absolute" onmousedown="this.parentNode.resizeMousedown(this, 'right')"></div>\n        `}templateDynamic(){return`\n        ${this.filepath}\n        <div class="element-bar-hiddenspace-left position-absolute">\n            <div class="element-bar-resize-hiddenspace-left position-absolute" onmousedown="this.parentNode.parentNode.resizeRangeMousedown(this, 'left')">\n            </div>\n        </div>\n        <div class="element-bar-hiddenspace-right position-absolute">\n            <div class="element-bar-resize-hiddenspace-right position-absolute" onmousedown="this.parentNode.parentNode.resizeRangeMousedown(this, 'right')">\n            </div>\n        </div>\n        `}getRandomArbitrary(e,t){return Math.round(Math.random()*(t-e)+e)}getRandomColor(){return`rgb(${this.getRandomArbitrary(45,167)},${this.getRandomArbitrary(23,139)},${this.getRandomArbitrary(56,180)})`}animationPanelMove(e){if("dynamic"==this.elementBarType)return 0;document.querySelector(`animation-panel[element-id="${this.elementId}"]`).move(e)}drag(e){if(this.isDrag){let t=e.pageX-this.initialPosition.x;e.pageY,this.initialPosition.y,this.style.left=`${t}px`,this.animationPanelMove(t),this.timeline[this.elementId].startTime=this.pxToMilliseconds(t)}}dragMousedown(e){this.addEventListener("mousemove",this.drag),this.isDrag=!0,this.initialPosition.x=e.pageX-Number(this.style.left.split("px")[0]),this.initialPosition.y=e.pageY,this.dragEventHandler=this.drag.bind(this),document.addEventListener("mousemove",this.dragEventHandler)}dragMouseup(){document.removeEventListener("mousemove",this.dragEventHandler),this.isDrag=!1}setWidth(e){this.style.width=`${e}px`}setLeft(e){this.style.left=`${e}px`}setTrimStart(e){this.querySelector(".element-bar-hiddenspace-left").style.width=`${e}px`}setTrimEnd(e){if(this.millisecondsToPx(this.timeline[this.elementId].duration)-this.millisecondsToPx(this.timeline[this.elementId].trim.startTime)<e)return 0;this.querySelector(".element-bar-hiddenspace-right").style.width=`${e}px`}millisecondsToPx(e){return e/5*(Number(document.querySelector("#timelineRange").value)/4)}pxToMilliseconds(e){return 5*e/(Number(document.querySelector("#timelineRange").value)/4)}resize(e){this.unselectThisElement(),this.isDrag=!1;let t=e.pageX-this.initialPosition.x,i=(e.pageY,this.initialPosition.y,this.initialDuration),n=document.querySelector("element-timeline").scrollLeft;"left"==this.resizeLocation?(this.setLeft(t),this.setWidth(i-t),this.timeline[this.elementId].startTime=this.pxToMilliseconds(t),this.timeline[this.elementId].duration=this.pxToMilliseconds(Number(this.style.width.split("px")[0])),this.animationPanelMove(t)):(this.setWidth(n+e.pageX-Number(this.style.left.split("px")[0])),this.timeline[this.elementId].duration=this.pxToMilliseconds(Number(this.style.width.split("px")[0])))}resizeRange(e){this.isDrag=!1;let t=e.pageX-this.initialPosition.x,i=this.initialDuration,n=Number(this.style.width.split("px")[0]),s=this.querySelector(".element-bar-hiddenspace-left"),l=this.querySelector(".element-bar-hiddenspace-right"),o=document.querySelector("element-timeline"),r=window.innerWidth,a=o.scrollWidth,d=Number(this.style.width.split("px")[0]),m=Number(this.style.left.split("px")[0]),h=r-n-m<0?a-(m+d):0,c=o.scrollLeft,u=a-r-c,p=r-n-m>0?r-n-m-10:0;"left"==this.resizeLocation?(this.setTrimStart(this.initialPosition.x+t+c-m),this.timeline[this.elementId].trim.startTime=this.pxToMilliseconds(Number(s.style.width.split("px")[0]))):(this.setTrimEnd(u+r-t-this.initialPosition.x-p-h),this.timeline[this.elementId].trim.endTime=this.pxToMilliseconds(i-Number(l.style.width.split("px")[0])))}resizeMousedown(e,t){this.isResize=!0,this.resizeLocation=t,this.isDrag=!1,this.initialPosition.x="left"==t?e.pageX-Number(this.style.left.split("px")[0]):Number(this.style.left.split("px")[0]),this.initialPosition.y=e.pageY,this.initialDuration=this.millisecondsToPx(this.timeline[this.elementId].duration)+Number(this.style.left.split("px")[0]),this.resizeEventHandler=this.resize.bind(this),document.addEventListener("mousemove",this.resizeEventHandler)}resizeRangeMousedown(e,t){this.isResize=!0,this.resizeLocation=t,this.resizeRangeLeft=Number(this.querySelector(".element-bar-hiddenspace-left").style.width.split("px")[0]),this.resizeRangeRight=Number(this.querySelector(".element-bar-hiddenspace-right").style.width.split("px")[0]),this.isDrag=!1,this.initialPosition.x=Number(this.style.left.split("px")[0]),this.initialDuration=this.millisecondsToPx(this.timeline[this.elementId].duration+Number(this.style.left.split("px")[0])),this.resizeEventHandler=this.resizeRange.bind(this),document.addEventListener("mousemove",this.resizeEventHandler)}resizeMouseup(){document.removeEventListener("mousemove",this.resizeEventHandler),this.isResize=!1}changeOutlineColor(e="add"){"add"==e?this.classList.add("border-inner-light"):"remove"==e&&this.classList.remove("border-inner-light")}selectThisElement(){const e=document.querySelector("element-control");if(e.selectElementsId.includes(this.elementId))return 0;e.selectElementsId.push(this.elementId),this.changeOutlineColor("add")}unselectThisElement(){const e=document.querySelector("element-control");e.selectElementsId=e.selectElementsId.filter((e=>e!==this.elementId)),this.changeOutlineColor("remove")}animationPanelDropdownTemplate(){if("dynamic"==this.elementBarType)return"";let e=this.isShowAnimationPanel(),t=1==e?"애니메이션 패널 닫기":"애니메이션 패널 열기";return`<menu-dropdown-item onclick=${1==e?`document.querySelector("animation-panel[element-id='${this.elementId}']").hide()`:`document.querySelector("animation-panel[element-id='${this.elementId}']").show()`} item-name="${t}"></menu-dropdown-item>`}isShowAnimationPanel(){return document.querySelector(`animation-panel[element-id='${this.elementId}']`).isShow}showMenuDropdown({x:e,y:t}){let i=this.animationPanelDropdownTemplate();document.querySelector("#menuRightClick").innerHTML=`\n            <menu-dropdown-body top="${t}" left="${e}">\n            ${i}\n\n            <menu-dropdown-item onclick="document.querySelector('element-timeline').removeSeletedElements()" item-name="삭제"> </menu-dropdown-item>\n        </menu-dropdown-body>`}handleMousedown(e){this.selectThisElement(),this.dragMousedown(e)}handleMouseup(e){this.rightclick(e),this.selectThisElement()}rightclick(e){if(3!=e.which&&2!=e.button)return 0;this.showMenuDropdown({x:e.clientX,y:e.clientY}),console.log("RC",e)}connectedCallback(){this.render(),this.addEventListener("mousedown",this.handleMousedown.bind(this)),this.addEventListener("mouseup",this.handleMouseup.bind(this)),document.addEventListener("mouseup",this.dragMouseup.bind(this)),document.addEventListener("mouseup",this.resizeMouseup.bind(this))}disconnectedCallback(){this.removeEventListener("mousedown",this.handleMousedown),this.removeEventListener("mouseup",this.handleMouseup),document.removeEventListener("mouseup",this.dragMouseup),document.removeEventListener("mouseup",this.resizeMouseup)}}class L extends HTMLElement{constructor(){super(),this.elementTimeline,this.timeline,this.timelineCursor,window.addEventListener("DOMContentLoaded",(()=>{this.elementTimeline=document.querySelector("element-timeline"),this.timeline=document.querySelector("element-timeline").timeline,this.timelineCursor=document.querySelector("element-timeline-cursor")})),this.scroller=void 0,this.resizeTimeout=void 0,this.resizeInterval=void 0,this.isResizeStart=!1,this.previousPreviewSize={w:1920,h:1080},this.isPaused=!0,this.isPlay={},this.activeElementId="",this.selectElementsId=[],this.existActiveElement=!1,this.progress=0,this.progressTime=0,this.previewRatio=1,this.resizeEvent()}async resizeEvent(){this.resizePreview(),clearTimeout(this.resizeTimeout),0==this.isResizeStart&&(this.isResizeStart=!0,this.resizeInterval=setInterval((()=>{this.matchAllElementsSizeToPreview()}),50)),this.resizeTimeout=setTimeout((()=>{clearInterval(this.resizeInterval),this.isResizeStart=!1}),300)}resizePreview(){let e=document.getElementById("split_col_2").offsetWidth,t=(document.getElementById("split_top").offsetHeight,document.getElementById("split_bottom").offsetHeight),i=document.getElementById("videobox").offsetHeight,n=document.getElementById("video").offsetHeight,s=(document.querySelector("element-timeline").offsetHeight,Math.round(.95*e)),l=Math.round(9*s/16),o=.92*(window.innerHeight-(t+20)-(i-n)),r=o*(16/9),a=s>r?r:s,d=l>o?o:l;preview.width=a,preview.height=d,preview.style.width=`${a}px`,preview.style.height=`${d}px`,video.style.width=`${a}px`,video.style.height=`${d}px`,this.previewRatio=1920/a}matchAllElementsSizeToPreview(e){for(const e in this.timeline)if(Object.hasOwnProperty.call(this.timeline,e)){let t=document.querySelector(`#element-${e}`),i=Number(this.timeline[e].height)/this.previewRatio,n=Number(this.timeline[e].width)/this.previewRatio,s=Number(this.timeline[e].location.y)/this.previewRatio,l=Number(this.timeline[e].location.x)/this.previewRatio;if(console.log(this.previewRatio),"text"!=this.timeline[e].filetype)t.resizeStyle({x:l,y:s,w:n,h:i});else if("text"==this.timeline[e].filetype){let i=Number(this.timeline[e].fontsize)/this.previewRatio;t.resizeStyle({x:l,y:s}),t.resizeFont({px:i})}}}removeElementById(e){this.querySelector(`element-control-asset[element-id="${e}"]`).remove(),this.timeline=document.querySelector("element-timeline").timeline}removeAllElementAsset(){this.querySelectorAll("element-control-asset").forEach((e=>{e.remove()})),this.timeline=document.querySelector("element-timeline").timeline}fitElementSizeOnPreview(e,t){let i={w:Number(document.querySelector("#video").style.width.split("px")[0]),h:Number(document.querySelector("#video").style.height.split("px")[0])},n=t<i.h?t:i.h;return{width:n*(e/t),height:n}}addImage(e,t){const i=this.generateUUID(),n=document.createElement("img");n.src=e,n.onload=()=>{let s=this.fitElementSizeOnPreview(n.width,n.height),l=s.width,o=s.height;this.timeline[i]={blob:e,startTime:0,duration:1e3,location:{x:0,y:0},width:l,height:o,localpath:t,filetype:"image",animation:{position:{isActivate:!1,points:[[],[]],allpoints:[[],[]]},opacity:{isActivate:!1,points:[[]],allpoints:[[]]}}},this.showImage(i),this.elementTimeline.addElementBar(i)}}addVideo(e,t){const i=this.generateUUID(),n=document.createElement("video");n.src=e,n.preload="metadata",n.onloadedmetadata=()=>{let s=n.videoWidth,l=n.videoHeight,o=1e3*n.duration;window.electronAPI.req.ffmpeg.getMetadata(e,t),window.electronAPI.res.ffmpeg.getMetadata(((n,r,a)=>{if(r!=e)return 0;let d=!1;console.log("MATA",a),a.streams.forEach((e=>{"audio"==e.codec_type&&(d=!0)})),console.log(d,"AUDIO"),this.timeline[i]={blob:e,startTime:0,duration:o,location:{x:0,y:0},trim:{startTime:0,endTime:o},width:s,height:l,localpath:t,isExistAudio:d,filetype:"video",codec:{video:"default",audio:"default"}},this.showVideo(i),this.elementTimeline.addElementBar(i)}))}}addText(){const e=this.generateUUID();this.timeline[e]={startTime:0,duration:1e3,text:"텍스트",textcolor:"#ffffff",fontsize:52,location:{x:0,y:0},localpath:"/TEXTELEMENT",filetype:"text",animation:{position:{isActivate:!1,points:[[],[]],allpoints:[[],[]]},opacity:{isActivate:!1,points:[[]],allpoints:[[]]}}},this.showText(e),this.elementTimeline.addElementBar(e)}addAudio(e,t){const i=this.generateUUID(),n=document.createElement("audio");n.src=e,n.onloadedmetadata=()=>{let s=1e3*n.duration;this.timeline[i]={blob:e,startTime:0,duration:s,location:{x:0,y:0},trim:{startTime:0,endTime:s},localpath:t,filetype:"audio"},this.showAudio(i),this.elementTimeline.addElementBar(i)}}showAnimation(e,t){let i=20*Math.round(document.querySelector("element-control").progressTime/20),n=Number(this.timeline[e].startTime),s=Math.round((i-n)/20);console.log(s);try{if(s<0)return 0;document.querySelector(`#element-${e}`).style.left=this.timeline[e].animation[t].allpoints[0][s].y/this.previewRatio+"px",document.querySelector(`#element-${e}`).style.top=this.timeline[e].animation[t].allpoints[1][s].y/this.previewRatio+"px"}catch(e){}}showImage(e){null==document.getElementById(`element-${e}`)?this.insertAdjacentHTML("beforeend",`<element-control-asset element-id="${e}" element-filetype="image"></element-control-asset>`):document.querySelector(`#element-${e}`).classList.remove("d-none");1==this.timeline[e].animation.position.isActivate&&this.showAnimation(e,"position")}showVideo(e){if(null==document.getElementById(`element-${e}`)){this.insertAdjacentHTML("beforeend",`<element-control-asset element-id="${e}" element-filetype="video"></element-control-asset>`);let t=document.getElementById(`element-${e}`).querySelector("video"),i=(this.timeline[e].startTime-this.progressTime)/1e3;t.currentTime=i}else{let t=document.getElementById(`element-${e}`).querySelector("video"),i=-(this.timeline[e].startTime-this.progressTime)/1e3;t.currentTime>0&&!t.paused&&!t.ended&&t.readyState>2?this.isPaused&&console.log("paused"):this.isPaused?(t.pause(),this.isPlay[e]=!1):(this.isPlay[e]||(t.currentTime=i,t.play()),this.isPlay[e]=!0),document.querySelector(`#element-${e}`).classList.remove("d-none")}}showAudio(e){if(null==document.getElementById(`element-${e}`)){this.insertAdjacentHTML("beforeend",`<element-control-asset element-id="${e}" element-filetype="audio"></element-control-asset>`);let t=document.getElementById(`element-${e}`).querySelector("audio"),i=(this.timeline[e].startTime-this.progressTime)/1e3;t.currentTime=i}else{let t=document.getElementById(`element-${e}`).querySelector("audio"),i=-(this.timeline[e].startTime-this.progressTime)/1e3;t.currentTime>0&&!t.paused&&!t.ended&&t.readyState>2?(this.isPaused&&console.log("paused"),console.log("isPlaying")):(t.currentTime=i,this.isPaused?t.pause():t.play()),document.querySelector(`#element-${e}`).classList.remove("d-none")}}showText(e){null==document.getElementById(`element-${e}`)?this.insertAdjacentHTML("beforeend",`<element-control-asset element-id="${e}" element-filetype="text"></element-control-asset>`):document.querySelector(`#element-${e}`).classList.remove("d-none"),1==this.timeline[e].animation.isActivate&&this.timeline[e].animation.allpoints.length>document.querySelector("element-control").progress&&this.showAnimation(e)}changeText(e){let t=document.querySelector(`#element-${e}`).querySelector("input").value;this.timeline[e].text=t}changeTextColor(e){let t=document.querySelector("#optionTargetElement").value;document.querySelector(`#element-${t}`).querySelector("input").style.color=e.value,this.timeline[t].textcolor=e.value}changeTextSize(e){let t=document.querySelector("#optionTargetElement").value,i=document.querySelector(`#element-${t}`),n=Number(e.value)/this.previewRatio;i.style.fontSize=`${n}px`,this.timeline[t].fontsize=Number(e.value)}changeTimelineRange(){const e=document.querySelector("element-timeline-ruler"),t=Number(document.querySelector("#timelineRange").value)/4;e.updateRulerSpace(t),this.timelineCursor.move(this.progressTime/5*t),this.adjustAllElementBarWidth(t),this.updateAllAnimationPanel()}updateAllAnimationPanel(){for(const e in this.timeline)if(Object.hasOwnProperty.call(this.timeline,e)){const t=this.timeline[e];if("image"!=t.filetype)continue;if(0==t.animation.position.isActivate)continue;let i=document.querySelector(`animation-panel[element-id="${e}"]`),n=document.querySelector(`element-bar[element-id="${e}"]`),s=n.millisecondsToPx(this.timeline[e].startTime);i.updateItem(),n.animationPanelMove(s)}}getTimeFromProgress(){let e=Number(document.querySelector("#timelineRange").value)/4;return 5*this.progress/e}getTimeFromTimelineBar(){return 5*Number(this.timelineCursor.style.left.split("px")[0])/(Number(document.querySelector("#timelineRange").value)/4)}adjustAllElementBarWidth(e){const t=document.querySelectorAll("element-bar");t.forEach((e=>{let t=e.getAttribute("element-id"),i=e.millisecondsToPx(this.timeline[t].duration),n=e.millisecondsToPx(this.timeline[t].startTime);if(e.setWidth(i),e.setLeft(n),"dynamic"==e.elementBarType){let i=e.millisecondsToPx(this.timeline[t].trim.startTime),n=e.millisecondsToPx(this.timeline[t].duration-this.timeline[t].trim.endTime);e.setTrimStart(i),e.setTrimEnd(n)}})),console.log(t)}getMillisecondsToISOTime(e){return new Date(e).toISOString().slice(11,22)}progressToTime(){let e=5*this.progress;return new Date(e).toISOString().slice(11,22)}generateUUID(){return w()}showTime(){const e=document.querySelector("#time"),t=this.getTimeFromTimelineBar(),i=this.getMillisecondsToISOTime(t);e.innerHTML=i}hideElement(e){"video"==this.timeline[e].filetype?this.pauseVideo(e):"audio"==this.timeline[e].filetype&&this.pauseAudio(e),document.querySelector(`#element-${e}`).classList.add("d-none")}appearAllElementInTime(){for(let e in this.timeline){let t=this.timeline[e].filetype,i=this.timeline[e].startTime>this.progressTime||this.timeline[e].startTime+this.timeline[e].duration<this.progressTime;"video"!=t&&"audio"!=t||(i=this.timeline[e].startTime+this.timeline[e].trim.startTime>this.progressTime||this.timeline[e].startTime+this.timeline[e].trim.endTime<this.progressTime),i?this.hideElement(e):"image"==t?this.showImage(e):"video"==t?this.showVideo(e):"text"==t?this.showText(e):"audio"==t&&this.showAudio(e)}}play(){let e=document.querySelector("#playToggle");e.setAttribute("onclick","elementControlComponent.stop()"),e.innerHTML='<span class="material-symbols-outlined icon-white icon-md"> stop_circle </span>',this.scroller=setInterval((()=>{let e=Number(document.querySelector("#timelineRange").value),t=Number(this.timelineCursor.style.left.split("px")[0])+e;this.progress=t,this.progressTime=this.getTimeFromProgress(),this.timelineCursor.move(t),this.showTime(),this.innerWidth+this.offsetWidth>=this.offsetWidth&&this.stop(),this.appearAllElementInTime()}),20),this.isPaused=!1}stop(){clearInterval(this.scroller);const e=document.querySelector("#playToggle");this.isPaused=!0;for(const e in this.timeline)Object.hasOwnProperty.call(this.timeline,e)&&(this.isPlay[e]=!1);e.setAttribute("onclick","elementControlComponent.play()"),e.innerHTML='<span class="material-symbols-outlined icon-white icon-md"> play_circle </span>',this.showTime(),this.pauseAllDynamicElements()}pauseVideo(e){let t=-(this.timeline[e].startTime-this.progressTime)/1e3,i=document.getElementById(`element-${e}`).querySelector("video");i.currentTime=t,i.pause()}pauseAudio(e){document.getElementById(`element-${e}`).querySelector("audio").pause()}pauseAllDynamicElements(){let e;for(e in this.timeline){let t=this.timeline[e].filetype;"video"==t?this.pauseVideo(e):"audio"==t&&this.pauseAudio(e)}}deactivateAllOutline(){for(const e in this.timeline)Object.hasOwnProperty.call(this.timeline,e)&&document.querySelector(`#element-${e}`).classList.remove("element-outline");this.activeElementId="",this.existActiveElement=!1}reset(){this.progress=0,this.progressTime=0,this.isPaused=!0,this.showTime(),this.appearAllElementInTime(),this.timelineCursor.move(0)}handleClickPreview(){this.deactivateAllOutline()}connectedCallback(){preview.addEventListener("click",this.handleClickPreview.bind(this))}}class I extends HTMLElement{constructor(){super(),this.timeline=document.querySelector("element-timeline").timeline,this.elementControl=document.querySelector("element-control"),this.elementId=this.getAttribute("element-id"),this.elementFiletype=this.getAttribute("element-filetype")||"image",this.isDrag=!1,this.isResize=!1,this.initialPosition={x:0,y:0,w:0,h:0},this.resizeDirection="n",this.resizeEventHandler,this.dragdownEventHandler,this.dragupEventHandler}render(){let e;"image"==this.elementFiletype?e=this.templateImage()+this.templateResize():"video"==this.elementFiletype?e=this.templateVideo()+this.templateResize():"text"==this.elementFiletype?e=this.templateText()+this.templateResize("horizon"):"audio"==this.elementFiletype&&(e=this.templateAudio());let t=this.convertAbsoluteToRelativeSize({x:this.timeline[this.elementId].location.x,y:this.timeline[this.elementId].location.y,w:this.timeline[this.elementId].width?this.timeline[this.elementId].width:500,h:this.timeline[this.elementId].height});if(this.classList.add("element-drag"),this.setAttribute("id",`element-${this.elementId}`),"text"!==this.elementFiletype)this.setAttribute("style",`width: ${t.w}px; top: ${t.y}px; left: ${t.x}px; height: ${t.h}px;`);else if("text"==this.elementFiletype){let e=this.elementControl.previewRatio,i=this.timeline[this.elementId].fontsize/e;this.setAttribute("style",`width: ${t.w}px; top: ${t.y}px; left: ${t.x}px; font-size: ${i}px;`)}this.innerHTML=e}convertAbsoluteToRelativeSize({x:e,y:t,w:i,h:n}){let s=this.elementControl.previewRatio;return{x:e/s,y:t/s,w:i/s,h:n/s}}convertRelativeToAbsoluteSize({x:e,y:t,w:i,h:n}){let s=this.elementControl.previewRatio;return{x:e*s,y:t*s,w:i*s,h:n*s}}templateImage(){return`\n        <img src="${this.timeline[this.elementId].blob}" alt="" class="element-image" draggable="false">`}templateVideo(){return`\n        <video src="${this.timeline[this.elementId].blob}" alt="" class="element-video" draggable="false"></video>`}templateAudio(){return`\n        <audio src="${this.timeline[this.elementId].blob}" class="d-none" draggable="false"></video>`}templateText(){return this.elementControl.previewRatio,`<input type="text" class="asset-transparent element-text" draggable="false" style="color: rgb(255, 255, 255); " onkeyup="document.querySelector('element-control').changeText('${this.elementId}')" value="${this.timeline[this.elementId].text}">`}templateResize(e="full"){let t='<div class="resize-n" onmousedown="this.parentNode.resizeMousedown(\'n\')"></div>',i='<div class="resize-s" onmousedown="this.parentNode.resizeMousedown(\'s\')"></div>',n='<div class="resize-w" onmousedown="this.parentNode.resizeMousedown(\'w\')"></div>',s='<div class="resize-e" onmousedown="this.parentNode.resizeMousedown(\'e\')"></div>';return"full"==e?`\n            ${t}\n            ${i}\n            ${n}\n            ${s}\n            <div class="resize-ne" onmousedown="this.parentNode.resizeMousedown('ne')"></div>\n            <div class="resize-nw" onmousedown="this.parentNode.resizeMousedown('nw')"></div>\n            <div class="resize-se" onmousedown="this.parentNode.resizeMousedown('se')"></div>\n            <div class="resize-sw" onmousedown="this.parentNode.resizeMousedown('sw')"></div>\n            `:"vertical"==e?`\n            ${t}\n            ${i}\n            `:"horizon"==e?`\n            ${n}\n            ${s}\n            `:void 0}pxToInteger(e="0px"){return Number(e.split("px")[0])}showDragAlignmentGuide(){let e=document.querySelector("drag-alignment-guide"),t=document.querySelector("#video"),i=Number(t.style.width.split("px")[0]),n=Number(t.style.height.split("px")[0]),s=Number(this.style.top.split("px")[0]),l=Number(this.style.left.split("px")[0]),o=Number(this.style.width.split("px")[0]),r=Number(this.style.height.split("px")[0]);if(s<6){e.showGuide({position:"top"});let t=0;this.style.top=`${t}px`;let i=this.convertRelativeToAbsoluteSize({y:t});this.timeline[this.elementId].location.y=i.y}else e.hideGuide({position:"top"});if(s+r>n-6){e.showGuide({position:"bottom"});let t=n-r;this.style.top=`${t}px`;let i=this.convertRelativeToAbsoluteSize({y:t});this.timeline[this.elementId].location.y=i.y}else e.hideGuide({position:"bottom"});if(l<6){e.showGuide({position:"left"});let t=0;this.style.left=`${t}px`;let i=this.convertRelativeToAbsoluteSize({x:t});this.timeline[this.elementId].location.x=i.x}else e.hideGuide({position:"left"});if(l+o>i-6){e.showGuide({position:"right"});let t=i-o;this.style.left=`${t}px`;let n=this.convertRelativeToAbsoluteSize({x:t});this.timeline[this.elementId].location.x=n.x}else e.hideGuide({position:"right"})}hideDragAlignmentGuide(){let e=document.querySelector("drag-alignment-guide");e.hideGuide({position:"top"}),e.hideGuide({position:"bottom"}),e.hideGuide({position:"left"}),e.hideGuide({position:"right"})}drag(e){if(this.isDrag){let t=e.clientX-this.initialPosition.x,i=e.clientY-this.initialPosition.y,n=["img","video","input"],s="";for(let e=0;e<n.length;e++)this.querySelector(n[e])&&(s=n[e]);if(t>window.innerWidth)document.removeEventListener("mousemove",this.dragdownEventHandler);else{this.style.top=`${i}px`,this.style.left=`${t}px`;let e=this.convertRelativeToAbsoluteSize({x:t,y:i});this.timeline[this.elementId].location.x=e.x,this.timeline[this.elementId].location.y=e.y}this.showDragAlignmentGuide()}}dragMousedown(e){this.isResize||(this.isDrag=!0,this.initialPosition.x=e.pageX-this.pxToInteger(this.style.left),this.initialPosition.y=e.pageY-this.pxToInteger(this.style.top),this.dragdownEventHandler=this.drag.bind(this),document.addEventListener("mousemove",this.dragdownEventHandler))}dragMouseup(){document.removeEventListener("mousemove",this.dragdownEventHandler),1==this.isDrag&&this.addAnimationPoint({animationType:"position"}),this.isDrag=!1,this.hideDragAlignmentGuide()}addAnimationPoint({animationType:e}){if(0==this.timeline[this.elementId].animation[e].isActivate)return 0;const t=Number(document.querySelector("#timelineRange").value)/4;let i=document.querySelector(`keyframe-editor[element-id="${this.elementId}"]`),n=this.elementControl.progress-this.timeline[this.elementId].startTime/5;({position:()=>{i.addPoint({x:n/t,y:this.timeline[this.elementId].location.x,line:0}),i.addPoint({x:n/t,y:this.timeline[this.elementId].location.y,line:1}),i.drawLine(0),i.drawLine(1)}})[e](),document.querySelector(`animation-panel[element-id="${this.elementId}"]`).updateItem()}getGcd(e,t){return 0==t?e:this.getGcd(t,e%t)}resize(e){this.isDrag=!1;const t=document.querySelector("#video").getBoundingClientRect();let i=e.pageX-t.left-this.initialPosition.x,n=e.pageY-t.top-this.initialPosition.y;switch(this.initialPosition.w,this.initialPosition.h,this.resizeDirection){case"n":this.resizeStyle({y:this.initialPosition.y+n,h:this.initialPosition.h-n});break;case"s":this.resizeStyle({y:this.initialPosition.y,h:n});break;case"w":this.resizeStyle({x:this.initialPosition.x+i,w:this.initialPosition.w-i});break;case"e":this.resizeStyle({x:this.initialPosition.x,w:i});break;case"ne":this.resizeStyle({y:this.initialPosition.y+n,h:this.initialPosition.h-n,w:i});break;case"nw":this.resizeStyle({x:this.initialPosition.x+i,y:this.initialPosition.y+n,h:this.initialPosition.h-n,w:this.initialPosition.w-i});break;case"sw":this.resizeStyle({x:this.initialPosition.x+i,h:n,w:this.initialPosition.w-i});break;case"se":this.resizeStyle({x:this.initialPosition.x,y:this.initialPosition.y,h:n,w:i})}let s=this.elementControl.previewRatio;this.timeline[this.elementId].location.y=Math.round(Number(this.style.top.split("px")[0])*s),this.timeline[this.elementId].location.x=Math.round(Number(this.style.left.split("px")[0])*s),this.timeline[this.elementId].width=Math.round(Number(this.style.width.split("px")[0])*s),this.timeline[this.elementId].height=Math.round(Number(this.style.height.split("px")[0])*s)}resizeStyle({x:e,y:t,w:i,h:n}){this.style.left=0==!e?`${e}px`:this.style.left,this.style.top=0==!t?`${t}px`:this.style.top,this.style.width=0==!i?`${i}px`:this.style.width,this.style.height=0==!n?`${n}px`:this.style.height}resizeFont({px:e}){if(!this.querySelector("input"))return 0;this.style.fontSize=`${e}px`}resizeMousedown(e){this.isDrag=!1,this.isResize=!0,this.resizeDirection=e,this.initialPosition.w=Number(this.style.width.split("px")[0]),this.initialPosition.h=Number(this.style.height.split("px")[0]),this.initialPosition.x=Number(this.style.left.split("px")[0]),this.initialPosition.y=Number(this.style.top.split("px")[0]),this.resizeEventHandler=this.resize.bind(this),document.addEventListener("mousemove",this.resizeEventHandler)}resizeMouseup(){document.removeEventListener("mousemove",this.resizeEventHandler),this.isResize=!1}activateOutline(){this.elementControl.deactivateAllOutline(),this.elementControl.activeElementId=this.elementId,this.elementControl.existActiveElement=!0,this.classList.add("element-outline")}showSideOption(){let e=new bootstrap.Offcanvas(document.getElementById("option_top")),t=["option_text"];for(let e=0;e<t.length;e++){const i=t[e];document.querySelector(`#${i}`).classList.add("d-none")}"text"==this.elementFiletype&&(document.querySelector("#option_text").classList.remove("d-none"),document.querySelector("#optionTargetElement").value=this.elementId,e.show())}handleMousedown(e){this.dragMousedown(e),this.activateOutline(e)}handleDoubleClick(e){this.showSideOption()}connectedCallback(){this.render(),this.addEventListener("mousedown",this.handleMousedown.bind(this)),this.addEventListener("dblclick",this.handleDoubleClick.bind(this)),document.addEventListener("mouseup",this.resizeMouseup.bind(this)),document.addEventListener("mouseup",this.dragMouseup.bind(this))}}class P extends HTMLElement{constructor(){super(),this.videoCanvas=document.querySelector("#video"),this.allPositions=["top","bottom","left","right","horizontal","vertical"]}addGuide(){for(let e=0;e<this.allPositions.length;e++){const t=this.allPositions[e];this.videoCanvas.insertAdjacentHTML("beforeend",`<alignment-guide position="${t}" class="alignment-guide alignment-guide-${t}"></alignment-guide>`),this.hideGuide({position:t})}}hideGuide({position:e}){this.videoCanvas.querySelector(`alignment-guide[position='${e}']`).classList.add("d-none")}showGuide({position:e}){this.videoCanvas.querySelector(`alignment-guide[position='${e}']`).classList.remove("d-none")}connectedCallback(){this.addGuide()}}class q extends HTMLElement{constructor(){super(),this.timeline=document.querySelector("element-timeline").timeline,this.elementId=this.getAttribute("element-id"),this.animationType=this.getAttribute("animation-type"),this.tension=1,this.divBody=void 0,this.svgBody={},this.poly={},this.path={},this.hiddenPath={},this.padding={start:0,end:0},this.lineCount=1,this.points=[[[0,0]],[[0,0]]],this.selectLine=0}render(){const e=this.template();this.innerHTML=e,this.divBody=this.querySelector("div"),this.svgBody=this.divBody.querySelector("svg"),this.keyframePointBody=this.divBody.querySelector("keyframe-point"),this.lineCount=this.timeline[this.elementId].animation[this.animationType].points.length,this.timeline[this.elementId].animation[this.animationType].isActivate=!0,this.clearLineEditorGroup();for(let e=0;e<this.lineCount;e++)this.addLineEditor(e),this.drawLine(e,!0),this.loadPoint(e);const t=Number(document.querySelector("#timelineRange").value)/4;this.addPadding({px:this.timeline[this.elementId].startTime/5*t,type:"start"}),this.querySelector("div").classList.add("h-100","position-relative"),this.classList.add("h-100","w-100","position-absolute","overflow-scroll"),document.querySelector(`animation-panel[element-id="${this.elementId}"]`).updateItem()}template(){return'\n        <div>\n        <keyframe-padding class="keyframe-padding" style="width: 100px;"></keyframe-padding>\n        <svg class="keyframe-svg" style="left: 100px;">\n\n        </svg>\n        <keyframe-point style="left: 100px;" class="position-absolute"></keyframe-point>\n\n        </div>'}addPadding({px:e,type:t}){let i=this.divBody.querySelector("keyframe-padding"),n=this.keyframePointBody,s=this.svgBody;const l={start:()=>{i.style.width=`${e}px`,n.style.left=`${e}px`,s.style.left=`${e}px`}};this.padding.start=e,l[t]()}highlightLineEditorButton(e){for(let e=0;e<this.lineCount;e++){let t=document.querySelector("#timelineOptionLineEditor").querySelector(`button[line='${e}']`);t.classList.remove("btn-primary"),t.classList.add("btn-secondary")}let t=document.querySelector("#timelineOptionLineEditor").querySelector(`button[line='${e}']`);t.classList.remove("btn-secondary"),t.classList.add("btn-primary")}changeLineEditor(e){this.selectLine=Number(e),this.highlightLineEditorButton(e)}addLineEditor(e){document.querySelector("#timelineOptionLineEditor").insertAdjacentHTML("beforeend",`<button line="${e}" onclick="document.querySelector('keyframe-editor').changeLineEditor('${e}')" type="button" class="btn btn-secondary btn-sm">Line${e}</button>`)}clearLineEditorGroup(){document.querySelector("#timelineOptionLineEditor").innerHTML=""}loadPoint(e){if(1==this.timeline[this.elementId].animation[this.animationType].isActivate){let t=this.timeline[this.elementId].animation[this.animationType].points[e];console.log(t);for(let i=0;i<t.length;i++){const n=t[i];0!=n[0]&&this.addPoint({x:n[0],y:n[1],line:e})}this.drawLine(e,!0)}}addPoint({x:e,y:t,line:i}){this.insertPointInMiddle({x:Math.round(e),y:Math.round(t),line:i}),console.log(this.points),this.drawPoint({x:e,y:t,line:i}),this.points[i][this.points[i].length-1][0],this.timeline[this.elementId].animation[this.animationType].isActivate=!0,this.timeline[this.elementId].animation[this.animationType].points[i]=this.points[i]}drawPoint({x:e,y:t,line:i}){let n=t-4,s=(e-4)*(Number(document.querySelector("#timelineRange").value)/4);this.keyframePointBody.insertAdjacentHTML("beforeend",`<div class="position-absolute keyframe-point" style="top: ${n}px; left: ${s}px;"></div>`)}insertPointInMiddle({x:e,y:t,line:i}){if(this.points[i].length-1==0)return this.points[i].push([e,t]),0;for(let n=0;n<this.points[i].length;n++){if(this.points[i].length-1==n)return this.points[i].splice(n+1,0,[e,t]),0;if(this.points[i][n][0]<e&&this.points[i][n+1][0]>e)return this.points[i].splice(n+1,0,[e,t]),0}}getRemovedDuplicatePoint({x:e,line:t}){let i=[];return this.points[t].forEach((t=>{t[0]!=e&&i.push(t)})),i}drawLine(e,t=!0){this.querySelector("svg").insertAdjacentHTML("beforeend",`\n        <polyline id="keyframePolyline${e}" />\n        <path id="keyframePath${e}" class="keyframe-path" />\n        <path id="keyframeHiddenPath${e}" class="d-none" />`);const i=Number(document.querySelector("#timelineRange").value)/4;let n=[];for(let t=0;t<this.points[e].length;t++)n.push([this.points[e][t][0]*i,this.points[e][t][1]]);console.log(">>>>>",this.points[e],n),this.path[e]=this.svgBody.querySelector(`path[id='keyframePath${e}']`),this.path[e].setAttribute("d",this.drawPath(n,this.tension)),this.hiddenPath[e]=this.svgBody.querySelector(`path[id='keyframeHiddenPath${e}']`),this.hiddenPath[e].setAttribute("d",this.drawPath(this.points[e],this.tension));let s=this.points[e][this.points[e].length-1][0]-1,l=this.getInterpolatedPoints(s,e,n);this.timeline[this.elementId].animation[this.animationType].allpoints[e]=l,console.log(this.drawPath(this.points[e],this.tension),this.drawPath(n,this.tension))}drawPath(e,t){null==t&&(t=1);let i=2*e.length,n=i-4,s="M"+[e[0][0],e[0][1]],l=0;for(let o=0;o<i-2;o+=2){let i=l?e[l-1][0]:e[0][0],r=l?e[l-1][1]:e[0][1],a=e[l][0],d=e[l][1],m=e[l+1][0],h=e[l+1][1],c=o!==n?e[l+2][0]:m,u=o!==n?e[l+2][1]:h;l+=1,s+="C"+[a+(m-i)/6*t,d+(h-r)/6*t,m-(c-a)/6*t,h-(u-d)/6*t,m,h]}return s}getPointAt(e,t){let i=0,n=this.hiddenPath[t].getTotalLength(),s=(i+n)/2,l=this.hiddenPath[t].getPointAtLength(s);for(;Math.abs(l.x-e)>.5;)l.x<e?i=s:n=s,s=(i+n)/2,l=this.hiddenPath[t].getPointAtLength(s);return{x:l.x,y:l.y}}getInterpolatedPoints(e,t){let i=[],n=0;for(let s=0;s<Math.round(e/4);s++)i.push(this.getPointAt(n,t)),n+=4;return i}handleMousedown(e){const t=Number(document.querySelector("#timelineRange").value)/4;let i=e.offsetX/t,n=e.offsetY;this.addPoint({x:i,y:n,line:this.selectLine}),this.drawLine(this.selectLine,!0),document.querySelector(`animation-panel[element-id="${this.elementId}"]`).updateItem()}handleScroll(e){if(0==document.querySelector("#option_bottom").classList.contains("show"))return 0;let t=document.querySelector("element-timeline");t.scrollTo(this.scrollLeft,t.scrollTop)}connectedCallback(){this.render(),this.svgBody.addEventListener("mousedown",this.handleMousedown.bind(this)),this.addEventListener("scroll",this.handleScroll.bind(this))}}class $ extends HTMLElement{constructor(){super(),this.x=this.getAttribute("top"),this.y=this.getAttribute("left")}render(){const e=this.innerHTML,t=this.template();this.innerHTML=t,this.style.display="inline-block",this.querySelector("ul").innerHTML=e}template(){return`\n        <ul class="dropdown-menu show position-absolute " style="top: ${this.x}px; left: ${this.y}px; z-index: 6000;">\n\n        </ul>`}mousedown(){setTimeout((()=>{this.remove()}),200)}connectedCallback(){this.render(),document.addEventListener("click",this.mousedown.bind(this))}disconnectedCallback(){document.removeEventListener("click",this.mousedown.bind(this))}}class A extends HTMLElement{constructor(){super(),this.name=this.getAttribute("item-name")||"untitle"}render(){const e=this.template();this.innerHTML=e}template(){return`<li><a class="dropdown-item">${this.name}</a></li>`}connectedCallback(){this.render()}}class M extends HTMLElement{constructor(){super(),this.elementId=this.getAttribute("element-id"),this.isShow=!1}render(){const e=this.innerHTML,t=this.template();this.innerHTML=t,this.hide(),this.style.display="inline-block",this.classList.add("position-relative","w-100","bg-dark"),this.querySelector("div").innerHTML=e}updateItem(){const e=this.querySelector("div").innerHTML;this.clearItem();const t=this.template();this.innerHTML=t,this.querySelector("div").innerHTML=e}move(e){this.style.left=`${e}px`}clearItem(){this.innerHTML=""}show(){this.classList.remove("d-none"),this.isShow=!0,this.updateItem()}hide(){this.classList.add("d-none"),this.isShow=!1}template(){return'<div class="bg-dark">  </div>'}connectedCallback(){this.render()}disconnectedCallback(){}}class k extends HTMLElement{constructor(){super(),this.animationType=this.getAttribute("animation-type"),this.elementId=this.getAttribute("element-id"),this.timeline=document.querySelector("element-timeline").timeline}render(){if(0==this.checkAnimationType())return 0;this.style.width="100%",this.style.height="1.5rem",this.style.display="inline-block",this.classList.add("position-relative","d-flex","align-items-center"),this.clearPoints(),this.insertPointFromTimeline()}insertPointFromTimeline(){const e=Number(document.querySelector("#timelineRange").value)/4;let t=this.timeline[this.elementId].animation[this.animationType].points[0];console.log(t);for(let i=0;i<t.length;i++){let n=t[i][0]*e;this.addPoint(n)}}clearPoints(){this.innerHTML=""}addPoint(e){this.insertAdjacentHTML("beforeend",`<div class="text-light position-absolute keyframe-diamond" style="left: ${e}px;">panel item </div>`)}checkAnimationType(){return["position","opacity"].includes(this.animationType)}showMenuDropdown({x:e,y:t}){document.querySelector("#menuRightClick").innerHTML=`<menu-dropdown-body top="${t}" left="${e}">\n            <menu-dropdown-item onclick="document.querySelector('element-timeline').showKeyframeEditor('${this.elementId}', '${this.animationType}')" item-name="키프레임 편집"></menu-dropdown-item>\n        </menu-dropdown-body>`}handleMouseup(e){this.rightclick(e)}rightclick(e){if(3!=e.which&&2!=e.button)return 0;this.showMenuDropdown({x:e.clientX,y:e.clientY})}connectedCallback(){this.render(),this.addEventListener("mouseup",this.handleMouseup.bind(this))}disconnectedCallback(){this.removeEventListener("mouseup",this.handleMouseup)}}customElements.define("asset-list",m),customElements.define("asset-file",h),customElements.define("asset-folder",c),customElements.define("asset-browser",u),customElements.define("asset-upload-drop",p),customElements.define("element-timeline",T),customElements.define("element-timeline-cursor",x),customElements.define("element-timeline-ruler",E),customElements.define("element-bar",S),customElements.define("element-control",L),customElements.define("element-control-asset",I),customElements.define("drag-alignment-guide",P),customElements.define("keyframe-editor",q),customElements.define("menu-dropdown-body",$),customElements.define("menu-dropdown-item",A),customElements.define("animation-panel",M),customElements.define("animation-panel-item",k),NUGGET=t})();