

<!DOCTYPE html>
<html lang="ko" class="h-100">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Nugget</title>

    <!-- CSS Dependencies -->

    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Team-DeVent/devent-designsystem/dist/style.css"/>

    <link rel="stylesheet" href="src/style/front.css">
    

</head>
    <body class="h-100 bg-dark">
        <div class="container-fluid h-100 ">

            <div id="split_top" class="row align-items-start" style="height: 80%;">
                <div id="split_col_1" class="bg-darklight h-100 overflow-y-scroll overflow-x-hidden position-relative pt-2" style="width: 30%;">
                    <div class="split-col-bar" onmousedown="startSplitColumns(1)"></div>

                    <ul class="nav nav-pills mb-3 mt-2 overflow-x-scroll" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                          <button class="btn btn-dark me-2 active" id="pills-asset-tab" data-bs-toggle="pill" data-bs-target="#pills-asset" type="button" role="tab" aria-controls="pills-asset" aria-selected="true">에셋</button>
                        </li>
                        <li class="nav-item" role="presentation">
                          <button class="btn btn-dark me-2 " id="pills-preset-tab" data-bs-toggle="pill" data-bs-target="#pills-preset" type="button" role="tab" aria-controls="pills-preset" aria-selected="false">프리셋</button>
                        </li>
                        <li class="nav-item" role="presentation">
                          <button class="btn btn-dark me-2 " id="pills-render-tab" data-bs-toggle="pill" data-bs-target="#pills-render" type="button" role="tab" aria-controls="pills-render" aria-selected="false">랜더링</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="pills-tabContent">
                        <div class="tab-pane fade show active" id="pills-asset" role="tabpanel" aria-labelledby="pills-asset-tab">
                            <input class="form-control bg-dark text-light mt-2"  type="file" name="upload" id="upload">
                            <button class="btn btn-transparent" onclick="nugget.asset.loadPrevDirectory()"><i class="fas fa-level-up-alt text-light"></i></button>
        
                            <div id="assetBrowser" class="row px-2"></div>
                        </div>
                        <div class="tab-pane fade" id="pills-preset" role="tabpanel" aria-labelledby="pills-preset-tab">
                            
                        </div>
                        <div class="tab-pane fade" id="pills-render" role="tabpanel" aria-labelledby="pills-render-tab">
                            <button class="btn btn-dark" onclick="nugget.canvas.preview.export()">export</button>
                            <button class="btn btn-dark" onclick="ipc.requestAllDir('/Users/hhj')">getDir</button>
                            <button class="btn btn-green-fill" onclick="ipc.render()">render</button>
                        </div>
                    </div>
                    
                </div>


                <div id="split_col_2" class="h-100" style="width: 70%;">
                    <div class="d-flex justify-content-center">
                        <div id="video" class="video">
                            <canvas id="preview" class="preview"></canvas>
                            <div id="control" class="control">
                                <div id="control-inner" class="control-inner" ondrop="nugget.element.control.drop(event)" ondragover="nugget.element.control.dragover(event)" onmouseup="nugget.element.control.onmouseup(event)">
    
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center mt-2">
                        <button id="playToggle" class="btn btn-transparent" onclick="nugget.element.player.start()"><i class="fas fa-play text-light"></i></button>
                        <button class="btn btn-transparent" onclick="nugget.element.player.reset()"><i class="fas fa-backward text-light"></i></button>
                    </div>
                </div>

            </div>

    
            <div id="split_bottom" class="row split-top align-items-end cursor-row-resize bg-darker line-top" style="height: 20%;">
                <div id="split_inner_bottom" class="col-12 cursor-default line" style="height: 100%;" onmouseup="nugget.element.bar.event.drag.onmouseup(this); nugget.element.bar.event.resize.onmouseup(this);">
                    <div id="timeline_bar" class="timeline-bar" style="left: 0px;">

                    </div>
                </div>
            </div>
        </div>

        <dds-modal
        modal-id="exportVideoModal"
        modal-title="영상 내보내기"
        modal-subtitle="">
            <dds-content>
                <div class="mb-3">
                    <video id="exportVideo" controls="controls"></video>
                </div>
            </dds-content>
            <dds-modal-button button-color="btn-blue" button-text-color="text-primary" is-dismiss="false">저장</dds-modal-button>
            <dds-modal-button button-color="btn-light" button-text-color="text-dark" is-dismiss="true">취소</dds-modal-button>
        </dds-modal>

        

  

        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.3.4/dist/sweetalert2.all.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/Team-DeVent/devent-designsystem/dist/main.js"></script>
        <script src="dist/index.js"></script>
        <script src="renderer.js"></script>

      <script>
          //document.querySelector("a").getAttribute
        let preview = document.getElementById('preview');
        let control = document.getElementById('control-inner');
        let video = document.getElementById('video');
        let exportVideoModal = new bootstrap.Modal(document.getElementById('exportVideoModal'), {
            keyboard: false
        })
        

        let valueEvent = {
            splitBottom: false,
            splitColumns: false,
            moveElement: false,
            mouse: {
                x: 0,
                y: 0
            },
            elementBar: {
                isDrag: false,
                isResize: false,
                resizeLocation: 'left',
                resizeRangeLeft: 0,
                resizeRangeRight: 0,
                e: undefined,
                blob: '',
                criteria: {x: 0, y: 0, duration: 1000},
                criteriaResize: {x: 0, y: 0}
            },
            element: {
                isDrag: false,
                e: undefined,
                initial: {x: 0, y: 0}
            }
        }


        const page = {
            split: {
                bottom: function (percent) {
                    document.getElementById("split_top").style.height = `${percent}%`
                    document.getElementById("split_bottom").style.height = `${100-percent}%`
                },
                columns: function (percent) {
                    document.getElementById("split_col_1").style.width = `${percent}%`
                    document.getElementById("split_col_2").style.width = `${100-percent}%`
                },
            },
            minWidth: 20,
            minHeight: 90
        }


        HTMLCanvasElement.prototype.render = function () {
            nugget.canvas.preview.render(this)
        };

        HTMLCanvasElement.prototype.clear = function () {
            nugget.canvas.preview.clear(this)
        };


        window.addEventListener('resize', nugget.canvas.preview.resize, false);

        window.addEventListener('load', (event) => {
            nugget.canvas.preview.resize()
            ipc.requestAllDir('/Users/hhj/Desktop')
        });
                

        upload.onchange = (event) => {
            let [ uploadfile ] = upload.files

            if (uploadfile) {
                let blob = URL.createObjectURL(uploadfile)
                let file = document.querySelector('#upload').files[0] || ''
                let path = uploadfile.path
                preview.src = blob

                nugget.element.control.upload.image(blob, path)
            }
        }





        




        document.addEventListener("dragstart", (e) => {
            let target = e.target

            if (target.classList.contains('element-drag')) {
                e.dataTransfer.effectAllowed = "copyMove";

                //e.preventDefault();


                valueEvent.element.isDrag = true
                valueEvent.element.e = target.parentNode

                valueEvent.element.initial.x = e.pageX - Number(target.style.left.split('px')[0])
                valueEvent.element.initial.y = e.pageY - Number(target.style.top.split('px')[0])

            }
        })

        document.addEventListener("drag", (e) => {
            let target = e.target
            //console.log(target, target.classList.contains('element-drag'))
            if (target.classList.contains('element-drag')) {
                let x =  e.clientX -valueEvent.element.initial.x
                let y = e.clientY -valueEvent.element.initial.y
                if (e.clientX + e.clientY != 0) nugget.element.control.drag(target, x, y);

            }
        })



        document.addEventListener("dragend", (e) => {
            let target = e.target
            if (target.classList.contains('element-drag')) {
                valueEvent.element.isDrag = false
            }
        })


        document.addEventListener("mousemove", (e) => {
            valueEvent.mouse.x = e.pageX
            valueEvent.mouse.y = e.pageY

            if (valueEvent.splitBottom) {
                let per = e.pageY/document.body.offsetHeight*100
                page.split.bottom(per)
            }

            if (valueEvent.splitColumns) {
                let per = e.pageX/document.body.offsetWidth*100 <= page.minWidth ? page.minWidth : e.pageX/document.body.offsetWidth*100
                page.split.columns(per)
                nugget.canvas.preview.resize()
            }

            if (nugget.element.bar.state.isDrag) {
                let x = e.pageX - nugget.element.bar.state.criteria.x
                let y = e.pageY - nugget.element.bar.state.criteria.y

                nugget.element.bar.drag(x, y)
            }

            if (nugget.element.bar.state.isResize) {
                nugget.element.bar.state.isDrag = false
                let elementId = nugget.element.bar.state.blob.split('/')[3]
                let filetype = nugget.element.timeline[elementId].filetype
                let x = e.pageX - nugget.element.bar.state.criteriaResize.x
                let y = e.pageY - nugget.element.bar.state.criteriaResize.y

                if (filetype == 'video') {
                    nugget.element.bar.resizeRangeOnElement(x, nugget.element.bar.state.resizeLocation)

                } else {
                    nugget.element.bar.resizeDurationInTimeline(x, nugget.element.bar.state.resizeLocation)

                }

            }

            if (nugget.element.control.state.isResize) {
                const videoBox = document.querySelector("#video");
                const rect = videoBox.getBoundingClientRect();

                let x = e.pageX - rect.left - nugget.element.control.state.criteriaResize.x
                let y = e.pageY - rect.top - nugget.element.control.state.criteriaResize.y

                nugget.element.control.resize.action(x, y)
            }

        })

        document.addEventListener("mouseup", (e) => {
              valueEvent.splitBottom = false
              valueEvent.splitColumns = false

          })


          document.getElementById("split_inner_bottom").addEventListener("mousedown", (e) => {
                e.stopPropagation();
          })

          document.getElementById("split_bottom").addEventListener("mousedown", (e) => {
              valueEvent.splitBottom = true
          })


          function startSplitColumns(colNumber) {
            valueEvent.splitColumns = true
          }



      </script>

    </body>
  </html>