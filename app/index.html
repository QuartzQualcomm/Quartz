

<!DOCTYPE html>
<html lang="ko" class="h-100">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


    <title>Nugget</title>

    <!-- CSS Dependencies -->

    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@500;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Team-DeVent/devent-designsystem/dist/style.css"/>

    <link rel="stylesheet" href="dist/style.css">
    
</head>
<asset-upload-drop></asset-upload-drop>
    <body class="h-100 bg-dark">

        <div class="container-fluid" style="height: 97vh;">
            <div id="split_top" class="row align-items-start" style="height: 80%;">
                <div id="split_col_1" class="bg-darklight h-100 overflow-y-hidden overflow-x-hidden position-relative p-0" style="width: 30%;">
                    <div class="split-col-bar" onmousedown="startSplitColumns(1)"></div>

                    <div class=" h-100 w-100 overflow-y-hidden overflow-x-hidden position-absolute ">

                        <div class="d-flex align-items-start h-100">
                            <div class="nav flex-column nav-pills bg-dark h-100 pt-1" style="width: 2.5rem;" role="tablist" aria-orientation="vertical">

                                <button class="btn-nav active" data-bs-toggle="pill" data-bs-target="#nav-home" type="button" role="tab" aria-selected="true"><span class="material-symbols-outlined">
                                    settings</span>
                                </button>

                                <button class="btn-nav" data-bs-toggle="pill" data-bs-target="#nav-draft" type="button" role="tab" aria-selected="false"><span class="material-symbols-outlined">
                                    draft</span>
                                </button>

                                <button class="btn-nav" data-bs-toggle="pill" data-bs-target="#nav-text" type="button" role="tab" aria-selected="false"><span class="material-symbols-outlined">
                                    text_fields</span>
                                </button>
                           
                                <button class="btn-nav" data-bs-toggle="pill" data-bs-target="#nav-output" type="button" role="tab" aria-selected="false"><span class="material-symbols-outlined">
                                    output</span>
                                </button>
                                
                            </div>
                            <div class="tab-content overflow-y-scroll overflow-x-hidden  p-2 h-100" style="width: calc(100% - 2.5rem);">


                              <div class="tab-pane fade show active" id="nav-home" role="tabpanel">
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control bg-dark text-light" placeholder="프로젝트 이름" >
                                </div>

                                <div class="input-group mb-3">
                                    <input id="projectFolder" type="text" class="form-control bg-dark text-light" placeholder="/" disabled>
                                    <button class="btn btn-sm bg-dark text-light" onclick="NUGGET.directory.select()">프로젝트 폴더 지정</button>
                                </div>
                                
                                <div class="input-group mb-3">
                                    <input id="projectDuration" type="number" class="form-control bg-dark text-light" placeholder="진행초 e.g) 0" onchange="document.querySelector('element-timeline-ruler').updateRulerLength(this)" value="10">
                                    <span class="input-group-text bg-dark text-light" id="basic-addon2">초</span>
                                </div>
                                <button class="btn btn-sm bg-dark text-light mt-1" onclick="NUGGET.project.save()">프로젝트 저장</button>
                                <button class="btn btn-sm bg-dark text-light mt-1" onclick="NUGGET.project.load()">프로젝트 불러오기</button>
                                <!-- <button class="btn btn-sm bg-primary text-light mt-1" onclick="window.electronAPI.req.progressBar.test()">PROGRESSBARTEST </button> -->

                                <br>
                              </div>

                              <div class="tab-pane fade" id="nav-draft" role="tabpanel" >
                                <asset-browser></asset-browser>
                                <asset-list></asset-list>
                              </div>

                              <div class="tab-pane fade" id="nav-text" role="tabpanel" >
                                <div class="row px-2">
                                    <div class="col-4 d-flex flex-column bd-highlight overflow-hidden mt-1 asset" onclick="elementControlComponent.addText()">
                                        <span class="material-symbols-outlined icon-lg align-self-center"> text_fields </span>
                                        <b class="align-self-center text-ellipsis text-light text-center">텍스트</b>
                                    </div>
                                </div>
                              </div>

                              <div class="tab-pane fade" id="nav-output" role="tabpanel" >
                                <button class="btn btn-blue-fill" onclick="ipc.render()">render</button>
                              </div>

                            </div>
                        </div>

                    </div>

                </div>

                <!-- PREVIEW -->
                <div id="split_col_2" class="h-100 position-relative d-flex align-items-center justify-content-center" style="width: 70%;">
                    <div id="videobox">
                        <div class="d-flex justify-content-center">
                            <div id="video" class="video">
                                <canvas id="preview" class="preview"></canvas>
                                <element-control></element-control>
                                <drag-alignment-guide></drag-alignment-guide>
                            </div>
                        </div>
                        <div class="d-flex justify-content-center mt-2">
                            <button id="playToggle" class="btn btn-transparent" onclick="elementControlComponent.play()"><span class="material-symbols-outlined icon-white icon-md"> play_circle </span></button>
                            <button class="btn btn-transparent" onclick="elementControlComponent.reset()"><span class="material-symbols-outlined icon-white icon-md"> replay_circle_filled </span></button>
                        </div>
                        <div class="d-flex justify-content-center mt-2">
                            <b id="time" class="text-light">00:00:00.00</b>
                        </div>
                    </div>
                </div>
            </div>

    
            <div id="split_bottom" class="row split-top align-items-end cursor-row-resize bg-darker line-top" style="height: 20%;">
                <element-timeline id="split_inner_bottom"></element-timeline>
            </div>
        </div>

        <div class="container-footer">
            <input type="range" class="form-range" min="0" max="10" step="0.2" id="timelineRange" value="4" oninput="elementControlComponent.changeTimelineRange()" onchange="elementControlComponent.changeTimelineRange()">
        </div>


        <!-- 
            OPTION
        -->
        <div class="offcanvas offcanvas-start" data-bs-scroll="true"  data-bs-backdrop="false" tabindex="-1" id="option_top" aria-labelledby="offcanvasRightLabel" style="width: 30%;">
            <div class="offcanvas-header">
                <h5 id="offcanvasRightLabel" class="text-light ms-3 mt-1">옵션</h5>
                <button type="button" class="btn btn-transparent btn-sm" data-bs-dismiss="offcanvas" aria-label="Close"><span class="material-symbols-outlined icon-white">close</span></button>
            </div>
            <div class="offcanvas-body">
                <input type="hidden" id="optionTargetElement" value="aaaa-aaaa-aaaa-aaaa">

                <div id="option_text" class="d-none">
                    <div class="mb-2">
                        <label class="form-label text-light">텍스트 색상 선택</label>
                        <input type="color" class="form-control form-control-color" oninput="elementControlComponent.changeTextColor(this)" value="#ffffff" title="Choose your color">
                    </div>

                    <div class="mb-2">
                        <label class="form-label text-light">폰트 크기</label>
                        <input type="number" class="form-control" onchange="elementControlComponent.changeTextSize(this)" value="52" >
                    </div>
                </div>

            </div>
        </div>


        <!-- 
            TIMELINE OPTION
        -->
        <div class="offcanvas offcanvas-bottom" data-bs-scroll="true"  data-bs-backdrop="false" tabindex="-1" id="option_bottom" aria-labelledby="offcanvasRightLabel" style="height: calc(20% - 2rem); ">
            <div class="offcanvas-header row d-flex justify-content-between">
                <div class="col">
                    <button type="button" class="btn btn-transparent btn-sm" data-bs-dismiss="offcanvas" aria-label="Close"><span class="material-symbols-outlined icon-white">close</span></button>

                </div>
                <div class="col text-end">
                    <div class="btn-group" role="group" id="timelineOptionLineEditor">
                    </div>
                </div>

            </div>
            <div class="">
                <input type="hidden" id="timelineOptionTargetElement" value="aaaa-aaaa-aaaa-aaaa">

                <div id="timelineOptionBody" class="d-none">

                </div>

            </div>
        </div>

        <!-- 
            MODAL
        -->
        <div>
            <dds-modal
            modal-id="exportVideoModal"
            modal-title="영상 내보내기"
            modal-subtitle="">
                <dds-content>
                    <div class="mb-3">
                        <video id="exportVideo" controls="controls"></video>
                    </div>
                </dds-content>
                <dds-modal-button button-color="btn-blue" button-text-color="text-primary" is-dismiss="false">저장</dds-modal-button>
                <dds-modal-button button-color="btn-light" button-text-color="text-dark" is-dismiss="true">취소</dds-modal-button>
            </dds-modal>
            
            
            
            <dds-modal
            modal-id="progressRender"
            modal-title="랜더링 중 이에요">
                <dds-content>
                    <div class="mb-3">
                        <div class="progress">
                            <div id="progress" class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
                        </div>
                    </div>
                </dds-content>
                <dds-modal-button button-color="btn-light" button-text-color="text-dark" is-dismiss="true">닫기</dds-modal-button>
            </dds-modal>
            
            
            <dds-modal
            modal-id="downloadFfmpeg"
            modal-title="FFMPEG 다운로드중">
                <dds-content>
                    <div class="mb-3">
                        <div class="progress">
                            <div id="download_progress_ffmpeg" class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
                        </div>
                    </div>
                </dds-content>
                <dds-modal-button button-color="btn-light" button-text-color="text-dark" is-dismiss="true">닫기</dds-modal-button>
            </dds-modal>
            
            <dds-modal
            modal-id="progressFinish"
            modal-title="랜더링이 완료되었어요">
                <dds-content>
                    <div class="mb-3">
            
                    </div>
                </dds-content>
                <dds-modal-button button-color="btn-blue-fill" is-dismiss="false" onclick="rendererUtil.openRenderedVideoFolder()">저장폴더 열기</dds-modal-button>
                <dds-modal-button button-color="btn-light" button-text-color="text-dark" is-dismiss="true">닫기</dds-modal-button>
            </dds-modal>
            
            <dds-modal
            modal-id="progressError"
            modal-title="랜더링중 문제가 발생했어요">
                <dds-content>
                    <div class="mb-3">
                        <p id="progressErrorMsg" class="text-secondary"></p>
            
                    </div>
                </dds-content>
                <dds-modal-button button-color="btn-light" button-text-color="text-dark" is-dismiss="true">닫기</dds-modal-button>
            </dds-modal>
            
            
            
            <dds-modal
            modal-id="whenClose"
            modal-title="정말 프로그램을 종료할까요?"
            modal-subtitle="변경사항은 저장되지 않아요.">
                <dds-content>
                    <div class="mb-3">
            
                    </div>
                </dds-content>
                <dds-modal-button button-color="btn-red-fill" is-dismiss="false" onclick="rendererUtil.forceClose()">네, 종료할게요</dds-modal-button>
                <dds-modal-button button-color="btn-light" button-text-color="text-dark" is-dismiss="true">아니요</dds-modal-button>
            </dds-modal>
        </div>

        <div id="menuRightClick"></div>



        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.3.4/dist/sweetalert2.all.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/Team-DeVent/devent-designsystem/dist/main.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>

        <script src="dist/index.js"></script>
        <script src="renderer.js"></script>

      <script>
          //document.querySelector("a").getAttribute

        const elementControlComponent = document.querySelector("element-control")
        let preview = document.getElementById('preview');
        let control = document.getElementById('control-inner');
        let video = document.getElementById('video');
        let exportVideoModal = new bootstrap.Modal(document.getElementById('exportVideoModal'), {
            keyboard: false
        })
        

        let valueEvent = {
            splitBottom: false,
            splitColumns: false,
            splitColumnsTarget: 1,
            moveElement: false,
            mouse: {
                x: 0,
                y: 0
            },
            elementBar: {
                isDrag: false,
                isResize: false,
                resizeLocation: 'left',
                resizeRangeLeft: 0,
                resizeRangeRight: 0,
                e: undefined,
                blob: '',
                criteria: {x: 0, y: 0, duration: 1000},
                criteriaResize: {x: 0, y: 0}
            },
            element: {
                isDrag: false,
                e: undefined,
                initial: {x: 0, y: 0}
            }
        }


        const page = {
            split: {
                bottom: function (percent) {
                    document.getElementById("split_top").style.height = `calc(${percent}% + 0.5rem)`
                    document.getElementById("split_bottom").style.height = `calc(${100-percent}% - 0.5rem)`
                    document.getElementById(`option_bottom`).style.height = `calc(${100-percent}% - 2rem)` // 옵션 오프캔버스                    

                },
                columns: function (percent) {
                    document.getElementById(`split_col_${valueEvent.splitColumnsTarget}`).style.width = `${percent}%`
                    document.getElementById(`split_col_${valueEvent.splitColumnsTarget+1}`).style.width = `${(100-percent)}%`
                    document.getElementById(`option_top`).style.width = `${percent}%` // 옵션 오프캔버스                    
                },
            },
            minWidth: 20,
            minHeight: 20
        }


        HTMLCanvasElement.prototype.render = function () {
            nugget.canvas.preview.render(this)
        };

        HTMLCanvasElement.prototype.clear = function () {
            nugget.canvas.preview.clear(this)
        };


        //window.addEventListener('resize', , false);
        window.onresize = async function(event) {
            await elementControlComponent.resizeEvent()
        };


        
        window.addEventListener('load', (event) => {
            //ipc.requestAllDir('/Users/hhj')
            //ipcRenderer.send('CLIENT_READY')
        });
                


        document.addEventListener("mousemove", (e) => {
            valueEvent.mouse.x = e.pageX
            valueEvent.mouse.y = e.pageY

            if (valueEvent.splitBottom) {
                let videoboxHeightPer = videobox.offsetHeight / window.innerHeight * 100
                let per = e.pageY/document.body.offsetHeight*100  <= page.minHeight ? page.minHeight : e.pageY/document.body.offsetHeight*100
                page.split.bottom(per)
                elementControlComponent.resizeEvent()
            }

            if (valueEvent.splitColumns) {
                let per = e.pageX/document.body.offsetWidth*100 <= page.minWidth ? page.minWidth : e.pageX/document.body.offsetWidth*100
                page.split.columns(per)
                elementControlComponent.resizeEvent()
            }


            /*

            if (nugget.element.bar.state.isDrag) {
                let x = e.pageX - nugget.element.bar.state.criteria.x
                let y = e.pageY - nugget.element.bar.state.criteria.y

                nugget.element.bar.drag(x, y)
            }

            if (nugget.element.bar.state.isResize) {
                nugget.element.bar.state.isDrag = false
                let elementId = nugget.element.bar.state.elementId
                let filetype = nugget.element.timeline[elementId].filetype
                let x = e.pageX - nugget.element.bar.state.criteriaResize.x
                let y = e.pageY - nugget.element.bar.state.criteriaResize.y

                if (filetype == 'video') {
                    nugget.element.bar.resizeRangeOnElement(x, nugget.element.bar.state.resizeLocation)

                } else {
                    nugget.element.bar.resizeDurationInTimeline(x, nugget.element.bar.state.resizeLocation)

                }

            }


            if (nugget.element.control.state.isDrag) {
                let x =  e.clientX - nugget.element.control.state.criteriaDrag.x
                let y = e.clientY - nugget.element.control.state.criteriaDrag.y
                if (e.clientX + e.clientY != 0) nugget.element.control.drag(x, y);
            }


            if (nugget.element.control.state.isResize) {
                const videoBox = document.querySelector("#video");
                const rect = videoBox.getBoundingClientRect();

                let x = e.pageX - rect.left - nugget.element.control.state.criteriaResize.x
                let y = e.pageY - rect.top - nugget.element.control.state.criteriaResize.y

                nugget.element.control.resize.action(x, y)
            }
            */
        })



        document.addEventListener("mouseup", (e) => {
              valueEvent.splitBottom = false
              valueEvent.splitColumns = false

          })






          document.getElementById("split_inner_bottom").addEventListener("mousedown", (e) => {
                e.stopPropagation();
          })

          document.getElementById("split_bottom").addEventListener("mousedown", (e) => {
            valueEvent.splitBottom = true
          })


          function startSplitColumns(colNumber) {
            valueEvent.splitColumns = true
            valueEvent.splitColumnsTarget = colNumber
          }



      </script>

    </body>
  </html>